import React, { useState, useEffect, useRef } from 'react';

const App = () => {
  const [tasks, setTasks] = useState([]);
  const [newTaskText, setNewTaskText] = useState('');
  const [newTaskDate, setNewTaskDate] = useState('');
  const [newTaskTime, setNewTaskTime] = useState('');
  const [newTaskRecurring, setNewTaskRecurring] = useState(false);
  const [newTaskPriority, setNewTaskPriority] = useState('medium');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterPriority, setFilterPriority] = useState('all');
  const [notification, setNotification] = useState('');
  const [editingTask, setEditingTask] = useState(null);
  const notificationRef = useRef(null);

  useEffect(() => {
    const now = new Date();
    setTasks([
      {
        id: crypto.randomUUID(),
        text: 'Review project proposal',
        completed: false,
        createdAt: now.toISOString(),
        dueDate: now.toISOString().split('T')[0],
        dueTime: new Date(now.getTime() + 15 * 60000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        isRecurring: false,
        notified: false,
        notifiedSoon: false,
        priority: 'high',
      },
    ]);
  }, []);

  useEffect(() => {
    const interval = setInterval(() => {
      const now = new Date();
      tasks.forEach(task => {
        if (!task.completed && task.dueDate && task.dueTime) {
          const due = new Date(`${task.dueDate} ${task.dueTime}`);
          const timeLeft = due - now;

          if (timeLeft <= 0 && !task.notified) {
            setNotification(`Task "${task.text}" is NOW DUE or OVERDUE!`);
            setTasks(prev =>
              prev.map(t => t.id === task.id ? { ...t, notified: true } : t)
            );
            if (notificationRef.current) clearTimeout(notificationRef.current);
            notificationRef.current = setTimeout(() => setNotification(''), 5000);
          } else if (timeLeft <= 60000 && !task.notifiedSoon) {
            setNotification(`Task "${task.text}" is due very soon!`);
            setTasks(prev =>
              prev.map(t => t.id === task.id ? { ...t, notifiedSoon: true } : t)
            );
            if (notificationRef.current) clearTimeout(notificationRef.current);
            notificationRef.current = setTimeout(() => setNotification(''), 5000);
          }
        }
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [tasks]);

  const handleAddTask = () => {
    if (!newTaskText.trim()) return;
    const now = new Date();
    setTasks(prev => [
      ...prev,
      {
        id: crypto.randomUUID(),
        text: newTaskText,
        completed: false,
        createdAt: now.toISOString(),
        dueDate: newTaskDate,
        dueTime: newTaskTime,
        isRecurring: newTaskRecurring,
        notified: false,
        notifiedSoon: false,
        priority: newTaskPriority,
      },
    ]);
    setNewTaskText('');
    setNewTaskDate('');
    setNewTaskTime('');
    setNewTaskRecurring(false);
    setNewTaskPriority('medium');
  };

  const handleDeleteTask = (id) => {
    setTasks(tasks.filter(task => task.id !== id));
  };

  const handleEditTask = (task) => {
    setEditingTask(task);
  };

  const handleSaveEdit = () => {
    setTasks(tasks.map(task => task.id === editingTask.id ? editingTask : task));
    setEditingTask(null);
  };

  const handleCompleteTask = () => {
    if (editingTask) {
      setTasks(tasks.map(task =>
        task.id === editingTask.id ? { ...task, completed: true } : task
      ));
      setEditingTask(null);
    }
  };

  const getPriorityBorder = (priority) => {
    switch(priority) {
      case 'low': return 'border-l-4 border-green-500';
      case 'medium': return 'border-l-4 border-yellow-400';
      case 'high': return 'border-l-4 border-red-500';
      default: return 'border-l-4 border-gray-500';
    }
  };

  const filteredTasks = tasks.filter(task => {
  const isCompleted = task.completed;
  const statusMatch =
    (filterStatus === 'completed' && isCompleted) ||
    (filterStatus === 'active' && !isCompleted) ||
    (filterStatus === 'all');
  const priorityMatch = filterPriority === 'all' || task.priority === filterPriority;
  return statusMatch && priorityMatch;
});

  return (
    <div className="min-h-screen bg-gradient-to-br from-black via-indigo-900 to-black flex flex-col items-center justify-center p-4 text-white font-sans relative animate-fadeIn">
      {notification && (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 px-4 py-2 rounded-full shadow-lg z-50 animate-pulse">
          {notification}
        </div>
      )}

      <div className="bg-gray-800 bg-opacity-80 p-8 rounded-2xl shadow-2xl w-full max-w-md z-10 transition-shadow duration-300 hover:shadow-[0_0_30px_10px_rgba(99,102,241,0.7)]">
        <h1 className="text-3xl font-bold text-center mb-6">My Advanced ToDo List</h1>

        <input type="text" placeholder="Task name" value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} className="w-full mb-3 p-2 rounded bg-gray-700 text-white border border-indigo-500 focus:ring-2 focus:ring-indigo-400" />
        <div className="flex gap-2 mb-3">
          <input type="date" value={newTaskDate} onChange={(e) => setNewTaskDate(e.target.value)} className="flex-1 p-2 rounded bg-gray-700 text-white border border-indigo-500 focus:ring-2 focus:ring-indigo-400" />
          <input type="time" value={newTaskTime} onChange={(e) => setNewTaskTime(e.target.value)} className="flex-1 p-2 rounded bg-gray-700 text-white border border-indigo-500 focus:ring-2 focus:ring-indigo-400" />
        </div>

        <label className="flex items-center gap-2 text-sm text-white mb-4">
          <input type="checkbox" checked={newTaskRecurring} onChange={(e) => setNewTaskRecurring(e.target.checked)} className="form-checkbox text-indigo-600" />
          Add this task every day
        </label>

        <div className="flex flex-col sm:flex-row gap-4 mb-4">
          <select
            className="flex-1 p-3 rounded-xl border border-purple-600 bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
            value={filterStatus}
            onChange={(e) => setFilterStatus(e.target.value)}
            title="Filter by Status"
          >
            <option value="all">All Tasks</option>
            <option value="active">Active Tasks</option>
            <option value="completed">Completed Tasks</option>
          </select>
          <select
            className="flex-1 p-3 rounded-xl border border-purple-600 bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
            value={filterPriority}
            onChange={(e) => setFilterPriority(e.target.value)}
            title="Filter by Priority"
          >
            <option value="all">All Priorities</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <button onClick={handleAddTask} className="w-full bg-indigo-600 hover:bg-indigo-500 transition p-2 rounded font-bold">
          Add Task
        </button>

        <div className="mt-6 space-y-4">
          {filteredTasks.length === 0 ? (
            <div className="text-center text-gray-400">No tasks found.</div>
          ) : (
            filteredTasks.map((task) => (
              <div key={task.id} className={`p-4 rounded-lg bg-gray-700 flex justify-between items-center shadow-md ${getPriorityBorder(task.priority)}`}>
                <div>
                  <div className="font-semibold">{task.text}</div>
                  <div className="text-sm text-gray-300">Due: {task.dueDate} {task.dueTime}</div>
                </div>
                <div className="flex gap-2">
                  {!task.completed && <button onClick={() => handleEditTask(task)} className="bg-blue-500 px-2 py-1 rounded text-sm hover:bg-blue-400">Edit</button>}
                  <button onClick={() => handleDeleteTask(task.id)} className="bg-red-600 px-2 py-1 rounded text-sm hover:bg-red-500">Delete</button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>

      {editingTask && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
          <div className="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-sm">
            <h2 className="text-xl font-bold mb-4 text-center">Edit Task</h2>
            <input type="text" value={editingTask.text} onChange={(e) => setEditingTask({ ...editingTask, text: e.target.value })} className="w-full mb-3 p-2 rounded bg-gray-700 text-white border border-indigo-500" />
            <input type="date" value={editingTask.dueDate} onChange={(e) => setEditingTask({ ...editingTask, dueDate: e.target.value })} className="w-full mb-3 p-2 rounded bg-gray-700 text-white border border-indigo-500" />
            <input type="time" value={editingTask.dueTime} onChange={(e) => setEditingTask({ ...editingTask, dueTime: e.target.value })} className="w-full mb-3 p-2 rounded bg-gray-700 text-white border border-indigo-500" />
            <div className="flex gap-2 justify-end">
              <button onClick={handleCompleteTask} className="px-4 py-2 bg-green-600 rounded hover:bg-green-500">Done</button>
              <button onClick={() => setEditingTask(null)} className="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">Cancel</button>
              <button onClick={handleSaveEdit} className="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-500">Save</button>
            </div>
          </div>
        </div>
      )}

      <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-40">
        <button
          onClick={() => alert('Get the app!')}
          className="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold rounded-full shadow-lg hover:scale-105 transition-all duration-300"
        >
          ðŸ“² Get the App
        </button>
      </div>

      <style>{`
        .animate-fadeIn {
          animation: fadeIn 1s ease-out forwards;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: scale(0.98); }
          to { opacity: 1; transform: scale(1); }
        }
      `}</style>
    </div>
  );
};

export default App;
